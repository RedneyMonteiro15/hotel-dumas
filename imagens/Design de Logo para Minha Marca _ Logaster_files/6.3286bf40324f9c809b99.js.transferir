(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{NW3t:function(t,e,a){"use strict";a.d(e,"a",function(){return s});var r=a("irIP"),i=a("fXoL");let s=(()=>{class t{constructor(){this.sharedKeyMode=!1,this.filtersMode=!1,this.defaultMode=!1,this.urlParamsAvailable=!1,this.paramsMap={sharedKey:null,types:null,tags:null,colors:null,name:null,fromSrc:null,whiteLabelEmail:null}}parseUrlParams(t){if(t.p)return this.setSharedKeyMode(),void(this.paramsMap.sharedKey=t.p);if(t.t&&(this.setFilterMode(),this.paramsMap.name=t.t),t.tags){this.setFilterMode();const e=t.tags.split(",").filter(t=>t);this.paramsMap.tags=e.map(t=>({name:t})).slice(0,11)}if(t.types){this.setFilterMode();const e=t.types.split(",").filter(t=>t),a=r.b.filter(t=>e.includes(t.urlParamsKey));this.paramsMap.types=0===a.length?r.b:a}if(t.colors){this.setFilterMode();const e=t.colors.split(",").filter(t=>t),a=r.a.filter(t=>e.includes(t.urlFilterName));this.paramsMap.colors=0===a.length?r.a:a}t.fromSrc&&(this.paramsMap.fromSrc=t.fromSrc),t.wlEmail&&(this.setFilterMode(),this.paramsMap.whiteLabelEmail=t.wlEmail),t.p||t.t||this.setDefaultMode()}setSharedKeyMode(){this.urlParamsAvailable=!0,this.filtersMode=!1,this.sharedKeyMode=!0}setFilterMode(){this.urlParamsAvailable=!0,this.filtersMode=!0,this.sharedKeyMode=!1}setDefaultMode(){this.urlParamsAvailable=!1,this.filtersMode=!1,this.sharedKeyMode=!1,this.defaultMode=!0}getParamsForWizard(){return this.paramsMap}isSharedKeyMode(){return this.sharedKeyMode}isFiltersMode(){return this.filtersMode}isDefaultMode(){return this.defaultMode}isUrlParamsAvailable(){return this.urlParamsAvailable}getSharedKey(){return this.paramsMap.sharedKey}setSharedKey(t){this.paramsMap.sharedKey=t}getWhiteLabelEmail(){return this.paramsMap.whiteLabelEmail}}return t.\u0275fac=function(e){return new(e||t)},t.\u0275prov=i.Hb({token:t,factory:t.\u0275fac,providedIn:"root"}),t})()},UNkC:function(t,e,a){"use strict";a.d(e,"a",function(){return j});var r=a("mrSG"),i=a("jtHE"),s=a("quSY"),n=a("R2xI"),h=a("mrhZ"),d=a("NwTh"),o=a("9U1V"),c=a("TNoi"),l=a("8Z5P"),u=a("Imjg"),v=a("WVmJ"),f=a("Bhu5"),p=a("mPvw");class g{constructor(t){this.context2d=t}measureIcons(t){return new Promise((e,a)=>{let r=[];for(let i of t)i.fillRatio>0||r.push(this.measure(i.svg,i.bounds).then(t=>{i.thickness=t.thickness,i.fillRatio=t.fillRatio,i.thicknessType=t.thicknessType,i.shape=t.shape}));0!==r.length?Promise.all(r).then(()=>{e()}):e()})}measure(t,e){null==o.a.canvgOptions&&(o.a.canvgOptions={ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,offsetX:0,offsetY:0,scaleWidth:0,scaleHeight:0});var a=this.context2d.canvas.width,r=this.context2d.canvas.height;this.context2d.clearRect(0,0,a,r),this.context2d.save();var i=new h.a(0,0,a,r),s=a/e.width,n=s;n*e.height>r&&(s=n=r/e.height);var g=new c.a;g.translate(-e.x,-e.y),g.scale(s,n),g.setToContext2d(this.context2d),t=u.a.changeEmblemAppearance(t,new v.a("000000")),p(this.context2d.canvas,t,o.a.canvgOptions),this.context2d.restore();var b=this.fillRatio(this.context2d,i,2);let y=[this.asyncBang(0,new d.a(i.width/2,0),90,i,"#ff0000"),this.asyncBang(200,new d.a(0,0),45,i,"#00ff00"),this.asyncBang(400,new d.a(0,i.height/2),0,i,"#0000ff"),this.asyncBang(600,new d.a(i.width-1,i.height-1),225,i,"#ff00ff"),this.asyncBang(800,new d.a(i.width/2,i.height-1),270,i,"#ffff00"),this.asyncBang(1e3,new d.a(i.width-1,i.height/2),180,i,"#00ffff"),this.asyncBang(1200,new d.a(0,i.height-1),315,i,"#ff0000"),this.asyncBang(1400,new d.a(i.width-1,0),135,i,"#00ff00")];return new Promise((t,r)=>{Promise.all(y).then(r=>{let i=Math.round(this.findTrendValue(r)/1.06);i=Math.round(1e3*i/a);let s={thickness:i,fillRatio:b,thicknessType:f.e.NotDefined,shape:l.a.calculateShape(e)};this.setThicknessType(s),t(s)})})}asyncBang(t,e,a,r,i){return new Promise((t,s)=>{t(this.bang(this.context2d,e,a,r,i))})}setThicknessType(t){t.thicknessType=f.e.NotDefined,t.thicknessType=t.thickness<40?f.e.Thin:t.thickness<60?f.e.Medium:t.thickness<=120?f.e.Bold:f.e.Filled,(t.fillRatio>35&&t.thicknessType==f.e.Thin||t.fillRatio>45)&&(t.thicknessType=f.e.Filled)}avg(t){var e=0;for(var a of t)e+=a;return e/t.length}a2b(t){return Math.sqrt((t[1].x-t[0].x)*(t[1].x-t[0].x)+(t[1].y-t[0].y)*(t[1].y-t[0].y))}l(t,e,a,r,i){t.beginPath(),t.strokeStyle=i,t.moveTo(r.x+e.x,r.y+e.y),t.lineTo(r.x+a.x,r.y+a.y),t.stroke()}polarF(t,e,a){var r=Math.PI*e/180;return new d.a(a*Math.cos(r)+t.x,a*Math.sin(r)+t.y)}bang(t,e,a,r,i){for(var s,n=this.findBangPoint(t,e,a,r),h=0,d=null,o=[],c=0;h<360;)d=this.curveEnd(t,n,h,r),h+=10,s=this.a2b([n,d]),0==c&&(c=s),s>12&&(c=s,o.push(Math.round(s)),this.l(t,n,d,r,i));return this.findTrendValue(o)}findTrendValue(t,e=10){var a,r,i=[],s=0;for(r=0;r<t.length;r++)void 0===i[a=Math.floor(t[r]/e)]?i[a]=[t[r]]:i[a].push(t[r]);for(r=0;r<i.length;r++)void 0!==i[r]&&(s=Math.max(s,i[r].length));for(r=0;r<i.length;r++)if(void 0!==i[r]&&i[r].length==s){var n=0;for(var h of i[r])n+=h;return Math.round(n/s)}return 0}findBangPoint(t,e,a,r){for(var i=0,s=e,n=t.getImageData(r.x,r.y,r.width,r.height);i=r.width*Math.round(s.y)+Math.round(s.x),0==n.data[3+(i*=4)];)if((s=this.polarF(s,a,1)).x<0||s.x>r.width||s.y<0||s.y>r.height){s.x<0&&(s.x=0),s.x>r.width&&(s.x=r.width),s.y<0&&(s.y=0),s.y>r.height&&(s.y=r.height);break}return s}curveEnd(t,e,a,r){for(var i=0,s=e,n=t.getImageData(r.x,r.y,r.width,r.height);i=r.width*Math.round(s.y)+Math.round(s.x),0!=n.data[3+(i*=4)];)if((s=this.polarF(s,a,1)).x<0||s.x>r.width||s.y<0||s.y>r.height){s.x<0&&(s.x=0),s.x>r.width&&(s.x=r.width),s.y<0&&(s.y=0),s.y>r.height&&(s.y=r.height);break}return s}fillRatio(t,e,a=2){var r=0,i=t.getImageData(e.x,e.y,e.width,e.height),s=0,n=e.width,d=e.height,o=0,c=0,l=0,u=0;for(l=0;l<e.width;l+=a)for(u=0;u<e.height;u+=a)r=e.width*Math.round(u)+Math.round(l),0!=i.data[3+(r*=4)]&&(s++,n=Math.min(n,l),d=Math.min(d,u),o=Math.max(o,l),c=Math.max(c,u));var v=new h.a(n,d,o-n,c-d);2==a&&(s*=4);let f=100*s/(v.width*v.height);return f=f>0&&0==Math.round(f)?1:Math.round(f),f}}var b=a("YDEh"),y=a("g5AA"),B=a("hX6w");class S{constructor(){this.makers=[new B.a]}getLogos(t,e,a=null){for(let r of this.makers)r.make(t,e,a)}getBrands(t,e,a=null){const r=[];for(let i of this.makers)r.push(i.makeBrand(t,e,a));return Promise.all(r)}resetUsage(){for(let t of this.makers)t.resetUsage()}}var m=a("UbVK"),w=a("ujYk"),M=a("UtAn"),P=a("7c6/"),x=a("AytR"),D=a("RWet"),I=a("I/rG"),E=a("pLZG"),k=a("zs7F"),T=a("gwEI"),L=a("FA7f"),A=a("fXoL"),O=a("0IaG"),R=a("tk/3"),C=a("IYfF"),W=a("rmxa"),U=a("yzWo"),K=a("ph+x"),F=a("NW3t"),z=a("71ha"),$=a("tyNb");let j=(()=>{class t{constructor(t,e,a,r,n,h,d,o,c,l){this.dialog=t,this.http=e,this.authService=a,this.layoutService=r,this.wizardService=n,this.spinnerService=h,this.urlParamsService=d,this.authModalService=o,this.activatedRoute=c,this.router=l,this.editCriterias$=new i.a(1),this.currentBrand$=new i.a(1),this.brandsState$=new i.a(1),this.savedBrandsIDs=[],this.trySave=!1,this.countOfLoaded=0,this.authSubscription=new s.a,this.currentBrands=[],this.maxCountLoad=4,this.logoFactory=new S,this.inputProcessor=new m.a,this.authSubscription.add(this.authService.subscribeAuthStatus().subscribe(t=>{this.authStatus=t})),this.authSubscription.add(this.authService.subscribeWhitelabelStatus().subscribe(t=>{this.authenticatedWhitelabel=t}))}get isCanLoadMore(){return this.countOfLoaded<this.maxCountLoad}loadBrands(){return Object(r.a)(this,void 0,void 0,function*(){this.urlParamsService.isSharedKeyMode()?(this.wizardService.setBrandProposalShouldBeSaved(!1),this.getProposedBrands()):this.urlParamsService.isFiltersMode()?(this.spinnerService.updateSpinnerState(this.spinnerService.spinnerActions.SHOW_EXTENDED),this.wizardService.setUrlParams(this.urlParamsService.getParamsForWizard()),this.brandCreationData=this.wizardService.getBrandsCreationalData(),this.wizardService.setBrandProposalShouldBeSaved(!0),yield this.reGenerateBrands()):(this.brandCreationData=this.wizardService.getBrandsCreationalData(),this.wizardService.setBrandProposalShouldBeSaved(!0),yield this.reGenerateBrands())})}setActiveBrand(t){this.currentBrand=t,this.currentBrand$.next(this.currentBrand)}getActiveBrand(){return this.currentBrand$.asObservable()}changeBrandColors(){return Object(r.a)(this,void 0,void 0,function*(){this.resetProposedBrandsStatus(this.currentBrands),this.refreshBrandCreationalData(),this.wizardService.setBrandProposalShouldBeSaved(!0),this.currentBrands.forEach(t=>{t.colorRange=b.a.getRandom(y.a.getColorRanges(this.brandCreationData.colorCategories))}),this.brandsState$.next({brands:this.currentBrands,isRegenerated:!1,shouldSaveProposedBrand:!0,isByLink:!1}),this.currentBrands.forEach(t=>{this.currentBrand&&t.uid===this.currentBrand.uid&&this.currentBrand$.next(t)})})}generateBrands(t=!1){return Object(r.a)(this,void 0,void 0,function*(){const e={inputData:this.brandCreationData.inputData,activityType:this.brandCreationData.industryIds[0],brandCreationData:this.brandCreationData};this.ruler=new g(T.a.forTemp(1e3,1e3)),yield this.ruler.measureIcons(e.brandCreationData.icons),(yield this.logoFactory.getBrands(e,(t,e)=>{})).forEach(a=>{a.forEach(t=>{t.colorRange=b.a.getRandom(y.a.getColorRanges(this.brandCreationData.colorCategories)),t.text=e.inputData.text}),this.currentBrands=[...this.currentBrands,...a],this.brandCreationData.setNounOffset(this.currentBrands),this.countOfLoaded+=1,this.wizardService.setBrandProposalShouldBeSaved(!0),this.brandsState$.next({brands:this.currentBrands,isRegenerated:t,shouldSaveProposedBrand:t,isByLink:!1})})})}reGenerateBrands(){return Object(r.a)(this,void 0,void 0,function*(){return this.logoFactory.resetUsage(),this.savedBrandsIDs=[],this.currentBrands=[],this.countOfLoaded=0,this.brandsState$.next(null),yield this.generateBrands(!0)})}getGeneratedBrands(){return this.brandsState$.asObservable().pipe(Object(E.a)(t=>null!==t))}saveProposedBrands(t,e=!1,a=!1,i){const s={brands:t.filter(t=>t.status!==I.a.STATUS_PROPOSED).map(t=>t.serialize()),creationData:this.brandCreationData.serialize(),sharedKey:this.getProposedBrandsKey()||null,fromSrc:this.urlParamsService.paramsMap.fromSrc,apiAccess:L.a.publicToken()};this.updateOrSaveProposedBrand(e,s).subscribe(e=>{a?this.redirectByWidget(e.sharedKey,i):(this.redirectByBUF(e.sharedKey),this.markProposedBrandsStatus(t),this.wizardService.resetWizardStepsStateMap())},()=>Object(r.a)(this,void 0,void 0,function*(){this.wizardService.resetWizardState(),this.spinnerService.updateSpinnerState(this.spinnerService.spinnerActions.HIDE)}))}updateOrSaveProposedBrand(t,e){return t?this.http.put(`${M.a.MAIN_URL}${x.a.proposedBrands}`,e):this.http.post(`${M.a.MAIN_URL}${x.a.proposedBrands}`,e)}getProposedBrands(){return Object(r.a)(this,void 0,void 0,function*(){const t=this.getProposedBrandsKey();t&&this.http.get(`${M.a.MAIN_URL}${x.a.proposedBrands}?sharedKey=${t}`).subscribe(t=>Object(r.a)(this,void 0,void 0,function*(){const e=n.a.deserializeManyNg(t.logos);this.currentBrands=[...e],this.brandCreationData=w.a.getInstance(),this.brandCreationData.deserialize(t.creationData),this.countOfLoaded=Math.floor(this.currentBrands.length/5),yield this.loadFonts(e),this.brandsState$.next({brands:this.currentBrands,isRegenerated:!0,shouldSaveProposedBrand:!1,isByLink:!0}),this.wizardService.setBrandsCreationalData(this.brandCreationData),setTimeout(()=>{this.wizardService.resetWizardStepsStateMap()},100)}),()=>Object(r.a)(this,void 0,void 0,function*(){return this.spinnerService.updateSpinnerState(this.spinnerService.spinnerActions.HIDE)}))})}loadFonts(t){const e=t.reduce((t,e)=>t.concat(e.usedFonts()),[]);return D.a.load(e)}redirectByWidget(t,e){let a="/a/wizard/logos?p="+t;a+=this.getExtraUrlParams(e),window.location.href=M.a.MAIN_URL+a}redirectByBUF(t){this.urlParamsService.setSharedKey(t),this.router.navigate([],{relativeTo:this.activatedRoute,queryParams:{p:t},replaceUrl:!0})}markProposedBrandsStatus(t){t.forEach(t=>t.status=I.a.STATUS_PROPOSED)}resetProposedBrandsStatus(t){t.forEach(t=>t.status=I.a.STATUS_DEFAULT)}getProposedBrandsKey(){return this.urlParamsService.getSharedKey()}shareBrandWithoutRedirect(){this.dialog.open(P.a,{autoFocus:!1,width:"470px",data:{brand:this.currentBrand,screen:null}})}openAccountPage(t){return Object(r.a)(this,void 0,void 0,function*(){yield this.router.navigate(["account",this.currentBrandId,t],{fragment:"",state:{redirectKey:t,brandId:this.currentBrandId}})})}openMobileEdit(){return Object(r.a)(this,void 0,void 0,function*(){yield this.saveBrandIfNeeded(),yield this.router.navigate(["editor",this.currentBrandId])})}isMobileEdit(){const t=this.authService.getPlanVersion();return k.a.allowMobileEditor(t)}saveBrandIfNeeded(t=!1){return Object(r.a)(this,void 0,void 0,function*(){if(this.currentBrand&&!this.savedBrandsIDs.includes(this.currentBrand.uid)){const t=yield this.currentBrand.singletonSave();this.currentBrandId=t.id,this.savedBrandsIDs.push(this.currentBrand.uid)}})}saveBrandAndRedirect(t){return Object(r.a)(this,void 0,void 0,function*(){return this.authStatus&&!this.isWhiteLabelMode(t)?(yield this.saveBrandIfNeeded(),void(yield this.redirectByKey(t))):this.authenticatedWhitelabel&&this.isWhiteLabelMode(t)?(yield this.saveWhiteLabel(),yield this.redirectByKey(t),void(this.authenticatedWhitelabel=!1)):(this.trySave=!0,void this.authModalService.showAuthModal(t))})}isWhiteLabelMode(t){return"WHITELABEL"===t||"WHITELABEL_EDIT"===t}redirectByKey(t){return Object(r.a)(this,void 0,void 0,function*(){switch(t){case"EDIT":this.redirectToEdit();break;case"SHARED":this.trySave?(yield this.shareBrandWithRedirect(),this.trySave=!1):this.shareBrandWithoutRedirect();break;case"NEXT":yield this.watchLogo();break;case"WHITELABEL":yield this.watchWhitelabelPresentation();break;case"WHITELABEL_EDIT":yield this.openWhitelabelEdit();break;case"logo":case"social":case"business-card":case"letterhead":case"brand-book":case"favicon":case"email-signature":yield this.openAccountPage(t)}})}refreshBrandCreationalData(){this.brandCreationData=this.wizardService.getBrandsCreationalData()}shareBrandWithRedirect(){return Object(r.a)(this,void 0,void 0,function*(){yield this.router.navigate(["account",this.currentBrandId,"logo"],{state:{share:!0,brandId:this.currentBrandId}})})}watchLogo(){return Object(r.a)(this,void 0,void 0,function*(){const t=this.authService.getPlanVersion(),e=k.a.isDashboardAccount(t),a=e?"dashboard":"logo",r=e?"dashboard":"logo";yield this.router.navigate(["account",this.currentBrandId,a],{state:{redirectKey:r,forcedReload:!0,brandId:this.currentBrandId}})})}watchWhitelabelPresentation(){return Object(r.a)(this,void 0,void 0,function*(){this.sharedUrl&&(window.location.href=this.sharedUrl+"?e=1")})}openWhitelabelEdit(){return Object(r.a)(this,void 0,void 0,function*(){if(this.sharedUrl){const t=this.sharedUrl.split("/"),e=t[t.length-2],a=this.authService.getVerificationKey(),r=encodeURIComponent(location.pathname+location.search);window.location.href=`/v3/s/${e}/edit?v=${a}&next=${r}`}})}saveWhiteLabel(){return Object(r.a)(this,void 0,void 0,function*(){if(this.currentBrand){this.currentBrand.shared=!0;const t=yield this.currentBrand.save();this.currentBrandId=t.id,this.sharedUrl=t.sharedUrl,yield this.authService.whitelabelCommitClientEmail(this.sharedUrl,this.currentBrand.text)}})}redirectToEdit(){return Object(r.a)(this,void 0,void 0,function*(){this.layoutService.isUnder1024?this.isMobileEdit()&&(yield this.openMobileEdit()):location.href=`${M.a.MAIN_URL}/v3/brands/${this.currentBrandId}/edit/`})}getExtraUrlParams(t){let e="";for(const[a,r]of Object.entries(t))r&&(e+=`&${a}=${r}`);return e}}return t.\u0275fac=function(e){return new(e||t)(A.Vb(O.b),A.Vb(R.a),A.Vb(C.a),A.Vb(W.a),A.Vb(U.a),A.Vb(K.a),A.Vb(F.a),A.Vb(z.a),A.Vb($.a,8),A.Vb($.d,8))},t.\u0275prov=A.Hb({token:t,factory:t.\u0275fac,providedIn:"root"}),t})()}}]);